name: Daily Forex Bilingual Report Bot

on:
  schedule:
    - cron: '0 0 * * *' # æ¯æ—¥æ—¥æœ¬æ™‚é–“ 9:00
  workflow_dispatch:

jobs:
  forex-report:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Rates and Analyze
        id: analyze
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          USDJPY=$(curl -s "https://open.er-api.com/v6/latest/USD" | jq '.rates.JPY')
          DATE=$(date '+%Y-%m-%d %H:%M')

          # Geminiã¸ã®æŒ‡ç¤ºï¼šè‹±èªã¨æ—¥æœ¬èªã§å‡ºåŠ›ã™ã‚‹ã‚ˆã†ã«æŒ‡å®š
          PROMPT="Current USD/JPY rate: ${USDJPY} (${DATE}). 
          Please act as a professional FX trader and provide a market report.
          
          OUTPUT FORMAT:
          1. Action: Start with 'ACTION: BUY' or 'ACTION: WAIT'.
          2. Report: Provide a brief analysis with 3 points for the action.
          3. Translation: Provide the Japanese translation for everything above.
          
          ---
          ç¾åœ¨1ãƒ‰ãƒ«${USDJPY}å††ã§ã™ã€‚ãƒ—ãƒ­ã®FXãƒˆãƒ¬ãƒ¼ãƒ€ãƒ¼ã¨ã—ã¦ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
          
          å‡ºåŠ›å½¢å¼ï¼š
          1. åˆ¤å®š: æœ€åˆã« 'ACTION: BUY' ã¾ãŸã¯ 'ACTION: WAIT' ã¨æ˜è¨˜ã—ã¦ãã ã•ã„ã€‚
          2. ãƒ¬ãƒãƒ¼ãƒˆ: ãã®åˆ¤å®šã®ç†ç”±ã‚’3ç‚¹ã€è‹±èªã§ä½œæˆã—ã¦ãã ã•ã„ã€‚
          3. æ—¥æœ¬èªè¨³: ä¸Šè¨˜ã®ãƒ¬ãƒãƒ¼ãƒˆå†…å®¹ã‚’ã™ã¹ã¦æ—¥æœ¬èªã§ç¿»è¨³ã—ã¦ãã ã•ã„ã€‚"

          ANALYSIS=$(curl -s \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=$GEMINI_API_KEY" \
            -H 'Content-Type: application/json' \
            -X POST \
            -d "{
              \"contents\": [{\"parts\":[{\"text\": \"$PROMPT\"}]}]
            }" | jq -r '.candidates[0].content.parts[0].text')

          # ç’°å¢ƒå¤‰æ•°ã¸ã®ä¿å­˜ï¼ˆãƒãƒ«ãƒãƒ©ã‚¤ãƒ³å¯¾å¿œï¼‰
          echo "REPORT_BODY<<EOF" >> $GITHUB_ENV
          echo "$ANALYSIS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          # åˆ¤å®šãƒã‚§ãƒƒã‚¯
          if [[ "$ANALYSIS" == *"ACTION: BUY"* ]]; then
            echo "SHOULD_NOTIFY=true" >> $GITHUB_ENV
          else
            echo "SHOULD_NOTIFY=false" >> $GITHUB_ENV
          fi

      - name: Show Report in Summary
        run: |
          echo "## ğŸ“Š Forex Analysis Report (EN/JP)" >> $GITHUB_STEP_SUMMARY
          echo "$REPORT_BODY" >> $GITHUB_STEP_SUMMARY

      - name: Send Notification (Create Issue)
        if: env.SHOULD_NOTIFY == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ FX BUY Alert / ç‚ºæ›¿è²·ã„ã‚·ã‚°ãƒŠãƒ«é€šçŸ¥',
              body: process.env.REPORT_BODY
            })
        env:
          REPORT_BODY: ${{ env.REPORT_BODY }}
