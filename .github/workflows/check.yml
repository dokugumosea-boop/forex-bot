name: Daily Forex Bilingual Report Bot

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  forex-report:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Rates and Analyze
        id: forex_analysis
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # 1. ç‚ºæ›¿å–å¾—
          USDJPY=$(curl -s "https://open.er-api.com/v6/latest/USD" | jq '.rates.JPY')
          DATE=$(date '+%Y-%m-%d %H:%M')

          # 2. APIã‚­ãƒ¼ãŒå…¥ã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆç©ºãªã‚‰ã“ã“ã§æ­¢ã‚ã‚‹ï¼‰
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "Error: GEMINI_API_KEY is not set in GitHub Secrets."
            exit 1
          fi

          # 3. Gemini APIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ (JSONã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã™ã“ã¨ã§ãƒŸã‚¹ã‚’é˜²ã)
          cat <<EOT > payload.json
          {
            "contents": [{
              "parts":[{
                "text": "Current USD/JPY: ${USDJPY} (${DATE}). Provide a professional trader's report. 1. Start with 'ACTION: BUY' or 'ACTION: WAIT'. 2. Write brief reasons. 3. Provide Japanese translation below."
              }]
            }]
          }
          EOT

          # 4. APIå®Ÿè¡Œ
          RESPONSE=$(curl -s -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}" \
            -H 'Content-Type: application/json' \
            -d @payload.json)

          # ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šAPIå¿œç­”ã®1è¡Œç›®ã‚’ãƒ­ã‚°ã«å‡ºåŠ›ï¼ˆã‚¨ãƒ©ãƒ¼å†…å®¹ã®ç‰¹å®šã«å½¹ç«‹ã¤ï¼‰
          echo "Debug API Response: $RESPONSE"

          # 5. çµæœã®æŠ½å‡º
          # jqã®çµæœãŒnullã‚„ç©ºã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥ã‚Œã‚‹
          ANALYSIS=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // empty')

          if [ -z "$ANALYSIS" ]; then
            ERROR_MSG=$(echo "$RESPONSE" | jq -r '.error.message // "Unknown API Error"')
            ANALYSIS="Error: Gemini API failed to generate text. Reason: $ERROR_MSG"
          fi
          
          echo "REPORT_BODY<<EOF" >> $GITHUB_ENV
          echo "$ANALYSIS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          if [[ "$ANALYSIS" == *"ACTION: BUY"* ]]; then
            echo "SHOULD_NOTIFY=true" >> $GITHUB_ENV
          else
            echo "SHOULD_NOTIFY=false" >> $GITHUB_ENV
          fi

      - name: Show Report in Summary
        run: |
          echo "## ğŸ“Š Forex Analysis Report (EN/JP)" >> $GITHUB_STEP_SUMMARY
          echo "$REPORT_BODY" >> $GITHUB_STEP_SUMMARY

      - name: Send Notification (Create Issue)
        if: env.SHOULD_NOTIFY == 'true'
        uses: actions/github-script@v7
        env:
          REPORT_BODY: ${{ env.REPORT_BODY }}
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ FX BUY Alert / ç‚ºæ›¿è²·ã„ã‚·ã‚°ãƒŠãƒ«é€šçŸ¥',
              body: process.env.REPORT_BODY
            })
