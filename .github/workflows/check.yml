name: Daily Forex Bilingual Report Bot

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  forex-report:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Rates and Analyze
        id: forex_analysis
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # ç‚ºæ›¿å–å¾—
          USDJPY=$(curl -s "https://open.er-api.com/v6/latest/USD" | jq '.rates.JPY')
          DATE=$(date '+%Y-%m-%d %H:%M')

          if [ -z "$GEMINI_API_KEY" ]; then
            echo "Error: GEMINI_API_KEY is not set."
            exit 1
          fi

          # APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ (æœ€ã‚‚å®‰å…¨ãªæ§‹é€ )
          RESPONSE=$(curl -s -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}" \
            -H 'Content-Type: application/json' \
            -d "{
              \"contents\": [{
                \"parts\":[{
                  \"text\": \"Current USD/JPY: ${USDJPY} (${DATE}). Analysis as FX trader. 1. Start with 'ACTION: BUY' or 'ACTION: WAIT'. 2. Brief reasons. 3. Japanese translation below.\"
                }]
              }]
            }")

          echo "Debug API Response: $RESPONSE"

          # çµæœã®æŠ½å‡º
          ANALYSIS=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // empty')

          if [ -z "$ANALYSIS" ] || [ "$ANALYSIS" == "null" ]; then
            ERROR_MSG=$(echo "$RESPONSE" | jq -r '.error.message // "Unknown Error"')
            ANALYSIS="Error: Gemini API failed. Reason: $ERROR_MSG"
          fi
          
          # GitHubç’°å¢ƒå¤‰æ•°ã¸ã®ä¿å­˜ (ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå½¢å¼)
          {
            echo "REPORT_BODY<<EOF"
            echo "$ANALYSIS"
            echo "EOF"
          } >> "$GITHUB_ENV"

          if [[ "$ANALYSIS" == *"ACTION: BUY"* ]]; then
            echo "SHOULD_NOTIFY=true" >> "$GITHUB_ENV"
          else
            echo "SHOULD_NOTIFY=false" >> "$GITHUB_ENV"
          fi

      - name: Show Report in Summary
        run: |
          echo "## ğŸ“Š Forex Analysis Report (EN/JP)" >> $GITHUB_STEP_SUMMARY
          echo "$REPORT_BODY" >> $GITHUB_STEP_SUMMARY

      - name: Send Notification (Create Issue)
        if: env.SHOULD_NOTIFY == 'true'
        uses: actions/github-script@v7
        env:
          REPORT_BODY: ${{ env.REPORT_BODY }}
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ FX BUY Alert / ç‚ºæ›¿è²·ã„ã‚·ã‚°ãƒŠãƒ«é€šçŸ¥',
              body: process.env.REPORT_BODY
            })
