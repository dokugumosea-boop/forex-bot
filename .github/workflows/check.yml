name: Daily Forex Bilingual Report Bot

on:
  schedule:
    - cron: '0 0 * * *' # æ¯æ—¥æ—¥æœ¬æ™‚é–“ 9:00
  workflow_dispatch:

jobs:
  forex-report:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Rates and Analyze
        id: forex_analysis  # é‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚ã«åå‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # 1. ç‚ºæ›¿å–å¾—
          USDJPY=$(curl -s "https://open.er-api.com/v6/latest/USD" | jq '.rates.JPY')
          DATE=$(date '+%Y-%m-%d %H:%M')

          # 2. Gemini APIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ (å®‰å…¨ãªæ›¸ãæ–¹ã«ä¿®æ­£)
          RESPONSE=$(curl -s -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=$GEMINI_API_KEY" \
            -H 'Content-Type: application/json' \
            -d "{
              \"contents\": [{
                \"parts\":[{
                  \"text\": \"Current USD/JPY: ${USDJPY} (${DATE}). Provide a professional trader's report. 1. Start with 'ACTION: BUY' or 'ACTION: WAIT'. 2. Write brief reasons. 3. Provide Japanese translation below. / ç¾åœ¨1ãƒ‰ãƒ«${USDJPY}å††ã§ã™ã€‚ãƒ—ãƒ­è¦–ç‚¹ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’è‹±èªã¨æ—¥æœ¬èªã§ä½œæˆã—ã¦ã€‚\"
                }]
              }]
            }")

          # APIã®å¿œç­”ã‚’ãƒ­ã‚°ã«å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
          echo "API Response: $RESPONSE"

          # 3. çµæœã®æŠ½å‡ºã¨ç’°å¢ƒå¤‰æ•°ã¸ã®ä¿å­˜
          ANALYSIS=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "Error: API response is empty or invalid"')
          
          echo "REPORT_BODY<<EOF" >> $GITHUB_ENV
          echo "$ANALYSIS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          # 4. åˆ¤å®šãƒ•ãƒ©ã‚°ã®è¨­å®š
          if [[ "$ANALYSIS" == *"ACTION: BUY"* ]]; then
            echo "SHOULD_NOTIFY=true" >> $GITHUB_ENV
          else
            echo "SHOULD_NOTIFY=false" >> $GITHUB_ENV
          fi

      - name: Show Report in Summary
        run: |
          echo "## ğŸ“Š Forex Analysis Report (EN/JP)" >> $GITHUB_STEP_SUMMARY
          echo "$REPORT_BODY" >> $GITHUB_STEP_SUMMARY

      - name: Send Notification (Create Issue)
        if: env.SHOULD_NOTIFY == 'true'
        uses: actions/github-script@v7
        env:
          REPORT_BODY: ${{ env.REPORT_BODY }}
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ FX BUY Alert / ç‚ºæ›¿è²·ã„ã‚·ã‚°ãƒŠãƒ«é€šçŸ¥',
              body: process.env.REPORT_BODY
            })
